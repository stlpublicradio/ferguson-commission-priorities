{% extends '_base.html' %}


{% block content %}

<div id="left">
  <p>Prioritize here:</p>
</div>
<div id="right">
  {% for row in COPY.priorities_1 %}
  <div class="priority" data-id="{{ row.id }}">
    <h2>{{ row.short_name }}</h2>
    <p>{{ row.details }}</p>
  </div>
  {% endfor %}
</div>

<div id="form" style="display:none;"><form/></div>
<iframe style="display:none;" name="hidden_iframe" id="hidden_iframe"></iframe>

<h3>All done?</h3>

<input name="submitButton"
    value="Submit"
    type="button"
    onclick="submitForm();" />



<script type="text/javascript">
dragula([document.getElementById('left'), document.getElementById('right')]);

localStorage.removeItem('priorities');


function getFormElement(item) {

    var $el,
        $outer = $('<div></div>')
                  .addClass('fs-form-item')
                  .toggleClass('required',item.required);

    $outer.append('<label>' + item.name + (item.required ? ' *' : '') + '</label>');

    if (item.name.toLowerCase() == 'x' || item.name.toLowerCase() == 'y') {

      return $('<input/>')
              .attr({
                type: 'hidden',
                name: item.field
              })
              .addClass(item.name.toLowerCase());

    } else if (item.type == 'textarea') {

      $el = $('<textarea></textarea>')
              .attr('name',item.field);

    } else if (item.type == 'select') {
      $el = $('<select></select>')
              .attr('name',item.field);

      $.each(item.choices,function(i,c){

        $el.append(

          $('<option></option>').text(c)

        );

      });

    } else if (item.type == 'radio' || item.type == 'checkbox') {

      $el = $('<div></div>');

      $.each(item.choices,function(i,c){

        var $i = $('<input/>').attr({
              name: item.field,
              type: item.type,
              value: c
            }),
            $s = $('<span/>').text(c);

        $el.append($i);
        $el.append($s);

      });
    } else {

      $el = $('<input/>').attr({
        name: item.field,
        type: item.type,
        value: ''
      });

    }

    $outer.append($el);

    return $outer;

  }

function initFromConfig(config) {

  var $form = $('#form form');

  //Don't populate the form or set listeners if they already submitted
   try {
     //If they've already submitted, don't let them resubmit
     if (localStorage.getItem('priorities')) {
       return true;
     }
   } catch (e) {}

   //Set the form action
   $form.attr('action',config.dataDestination)
         .attr('method',config.dataMethod || "post")
         .attr('target', 'hidden_iframe')
         .attr('onsubmit', 'submitted=true');


   //Create the form fields
   $.each(config.fields || [],function(i,f){

     $form.append(getFormElement(f));

   });


   // fill out form
   var elements = [];

   priorities = $('#left div').map(function() {
       var $item = $(this);
       return { id: $item.data('id')};
   }).get()
   $inputs = $('form *');
   $form = $('form');

   $inputs.filter('input').each(function(i, input){
console.log(input)

       if (priorities[i]) {
           var number = priorities[i].id;
           $(this).val(number);
       }
       else {
           $(this).val('');
       }
   });

   //Append a submit button
   $form.submit();

   try {
  //put priorities into localStorage to mark that they submitted it
  localStorage.setItem('priorities',JSON.stringify(priorities));
} catch(e) {}


 }


submitForm = function() {

    $.getJSON("js/config.json",initFromConfig);
}

</script>
{% endblock %}
