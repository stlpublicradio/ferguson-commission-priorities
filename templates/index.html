{% extends '_base.html' %}


{% block content %}

<div id="left">
  <p>Prioritize here:</p>
</div>
<div id="right">
  {% for row in COPY.priorities_1 %}
  <div class="priority" data-id="{{ row.id }}">
    <h2>{{ row.short_name }}</h2>
    <p>{{ row.details }}</p>
  </div>
  {% endfor %}
</div>

<div id="submit">
<div id="form" style="display:none;"><form/></div>
<iframe style="display:none;" name="hidden_iframe" id="hidden_iframe"></iframe>

<h3>All done?</h3>
</div>




<script type="text/javascript">
// Testing purposes; remove for production
// localStorage.removeItem('priorities');

var input_data;
var data;

compileData();

pageInit();

function setUpPage() {
    setUpDragging();
    $('#submit').append('<input name="submitButton" value="Submit" type="button" onclick="submitForm();" />');

    var details = $('body').find('.details');

    details.trunk8({
        fill: '&hellip; <a class="read-more" href="#">read more</a>'
    });

    details.on('click', '.read-more', function(event) {
        $(this).parent().trunk8('revert').append('<a class="read-less" href="#">read less</a>');

        return false;
    });

    details.on('click', '.read-less', function (event) {
        $(this).parent().trunk8();

        return false;
    });

    // $('.read-more').on('click', function(event) {
    //     $(this).parent().trunk8('revert').append('<a class="read-less" href="#">read less</a>');
    //
    //     return false;
    // });

    // $('.read-less').on('click', function (event) {
    //     $(this).parent().trunk8();
    //
    //     return false;
    // });
}

function displayResults() {
    console.log("already submitted!")

    // list priorities in previously-submitted order
    priorities = $.parseJSON(localStorage.getItem('priorities'))

    $.each(priorities, function(i, item) {
        var pri = $('div').find('[data-id="' + item.id + '"]');
        pri.detach();
        $('#left').append(pri);
    });

    // move other unsubmitted priorities to bottom of list
    $("#right div").each(function(i) {
        $(this).detach();
        $('#left').append($(this));
    });

    // remove div with submit stuff in it
    $('#submit').remove();

}

// load all users' data

function compileData() {
    d3.json("test.js", function(error, json) {
      if (error) return console.warn(error);
      input_data = json;
      visualizeit();
    });

};

function visualizeit(){

    var how_many_props = 11;
    var data = new Array();
    var placements = new Array();

    // splitting entries json up into usable lists
    $.each(input_data.feed.entry, function(i,entry){
        var templist = new Array();
        entries = entry.content.$t;
        entries = entries.split(',');

        $.each(entries,function(j,listItem){
            listItem = listItem.split(': ');
            listItem = listItem[1];
            templist[j] = listItem;
        })

        data[i] = templist;
    })

    // get totals by placement
    for (i = 0; i < how_many_props; i++) {
        templist = [];
        for ( j = 0; j < how_many_props; j++) {
            n = 0;
            for ( k = 0; k < data.length; k++) {
                n = n + (data[k][j] == i+1);
            }
            templist[j] = n;
        }
        placements[i] = templist;
    }

    var priority_divs = d3.select('#left').selectAll('.priority').append('div')
    .datum(function(d) { return d3.select(this.parentNode).attr("data-id"); })

    console.log(priority_divs)

    priority_divs.data(placements, function(d) { return priority_divs.attr("data-id");});

    console.log(priority_divs)


}

function pageInit(){
    //Don't populate the form or set listeners if they already submitted
     try {
       //If they've already submitted, don't let them resubmit
       if (localStorage.getItem('priorities')) {
         displayResults();
       }
       else {
           setUpPage();
       }
     } catch (e) {}

};


function submitForm() {
    $.getJSON("js/config.json",initFromConfig);
}


function setUpDragging() {
    var drake = dragula([document.getElementById('left'), document.getElementById('right')]);
}

function getFormElement(item) {
    var $el,
        $outer = $('<div></div>')
                  .addClass('fs-form-item')
                  .toggleClass('required',item.required);

    $outer.append('<label>' + item.name + (item.required ? ' *' : '') + '</label>');

    if (item.name.toLowerCase() == 'x' || item.name.toLowerCase() == 'y') {

      return $('<input/>')
              .attr({
                type: 'hidden',
                name: item.field
              })
              .addClass(item.name.toLowerCase());

    } else if (item.type == 'textarea') {

      $el = $('<textarea></textarea>')
              .attr('name',item.field);

    } else if (item.type == 'select') {
      $el = $('<select></select>')
              .attr('name',item.field);

      $.each(item.choices,function(i,c){

        $el.append(

          $('<option></option>').text(c)

        );

      });

    } else if (item.type == 'radio' || item.type == 'checkbox') {

      $el = $('<div></div>');

      $.each(item.choices,function(i,c){

        var $i = $('<input/>').attr({
              name: item.field,
              type: item.type,
              value: c
            }),
            $s = $('<span/>').text(c);

        $el.append($i);
        $el.append($s);

      });
    } else {

      $el = $('<input/>').attr({
        name: item.field,
        type: item.type,
        value: ''
      });

    }

    $outer.append($el);

    return $outer;

  }

function initFromConfig(config) {

  var $form = $('#form form');

  //Don't populate the form or set listeners if they already submitted
   try {
     //If they've already submitted, don't let them resubmit
     if (localStorage.getItem('priorities')) {
       return true;
     }
   } catch (e) {}

   //Set the form action
   $form.attr('action',config.dataDestination)
         .attr('method',config.dataMethod || "post")
         .attr('target', 'hidden_iframe')
         .attr('onsubmit', 'submitted=true');

   //Create the form fields
   $.each(config.fields || [],function(i,f){
     $form.append(getFormElement(f));
   });

   // fill out form
   var elements = [];

   priorities = $('#left div').map(function() {
       var $item = $(this);
       return { id: $item.data('id')};
   }).get()
   $inputs = $('form *');
   $form = $('form');

   $inputs.filter('input').each(function(i, input){


       if (priorities[i]) {
           var number = priorities[i].id;
           $(this).val(number);
       }
       else {
           $(this).val('');
       }
   });

   //Append a submit button
   $form.submit();

   try {
  //put priorities into localStorage to mark that they submitted it
  localStorage.setItem('priorities',JSON.stringify(priorities));
} catch(e) {}
}

</script>
{% endblock %}
